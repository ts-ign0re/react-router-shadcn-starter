stages:
  - install
  - check
  - test

variables:
  PNPM_HOME: /root/.local/share/pnpm
  NODE_VERSION: "22"

default:
  image: node:${NODE_VERSION}-alpine
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
      - apps/*/node_modules
      - packages/*/node_modules
  before_script:
    - corepack enable
    - corepack prepare pnpm@9.0.0 --activate
    - pnpm config set store-dir .pnpm-store

install:
  stage: install
  script:
    - pnpm install --frozen-lockfile

lint:
  stage: check
  needs:
    - install
  script:
    - pnpm lint

format:
  stage: check
  needs:
    - install
  script:
    - pnpm format

check-types:
  stage: check
  needs:
    - install
  script:
    - pnpm check-types

test:
  stage: test
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  needs:
    - install
  before_script:
    - corepack enable
    - corepack prepare pnpm@9.0.0 --activate
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm test
  artifacts:
    when: always
    paths:
      - apps/client/playwright-report/
    expire_in: 1 week
